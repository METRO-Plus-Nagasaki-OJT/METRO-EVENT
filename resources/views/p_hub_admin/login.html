{% extends 'dashboard/auth.html' %}
{% load static %}

{% block content %}
<div x-data="login"
    class="flex justify-center items-center min-h-screen bg-gray-100">
    <div class="border-8 border-gray-300 rounded-lg p-8 max-w-md w-full">
        <h1 class="text-center font-bold text-3xl mb-8"> ログイン </h1>
        <div x-cloak x-show="credentialError" x-transition:enter.duration.500ms class="flex items-center p-4 mb-4 text-sm text-red-800 border border-red-300 rounded-lg bg-red-50 dark:bg-gray-800 dark:text-red-400 dark:border-red-800"
            role="alert">
            <svg class="flex-shrink-0 inline w-4 h-4 me-3" aria-hidden="true"
                xmlns="http://www.w3.org/2000/svg" fill="currentColor"
                viewBox="0 0 20 20">
                <path
                    d="M10 .5a9.5 9.5 0 1 0 9.5 9.5A9.51 9.51 0 0 0 10 .5ZM9.5 4a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3ZM12 15H8a1 1 0 0 1 0-2h1v-3H8a1 1 0 0 1 0-2h2a1 1 0 0 1 1 1v4h1a1 1 0 0 1 0 2Z" />
            </svg>
            <span class="sr-only">Info</span>
            <div x-text="credentialError"></div>
        </div>
        <form id="loginForm" x-clover-form="submitForm" class="space-y-4"
            x-ref="form">
            {% csrf_token %}
            <div class="mb-4">
                <label for="inputUsername"
                    class="block mb-2 font-medium text-gray-700">ユーザー名</label>
                <input x-clover-verify type="text" id="inputUsername"
                    name="username" placeholder="ユーザー名を入力してください"
                    class="block w-full px-3 py-2 border rounded-lg shadow-sm focus:outline-none focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50">
                <div x-text="errors.username" class="text-red-500 text-sm mt-1">
                </div>
            </div>
            <div class="mb-4">
                <label for="inputPassword"
                    class="block mb-2 font-medium text-gray-700">パスワード</label>
                <input x-clover-verify type="password" id="inputPassword"
                    name="password" placeholder="パスワードを入力してください"
                    class="block w-full px-3 py-2 border rounded-lg shadow-sm focus:outline-none focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50">
                <div x-text="errors.password" class="text-red-500 text-sm mt-1">
                </div>
            </div>
            <div class="py-5">
                <button type="submit"
                    class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg focus:outline-none focus:shadow-outline">
                    ログイン
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock content %}
{% block script %}
<script>
    document.addEventListener('alpine:init', () => {
        Alpine.data('login', () => ({
            rule: {
                "username": [Clover.rule.required("ユーザー名が必要です。")],
                "password": [Clover.rule.required("パスワードが必要です。")]
            },
            errors: {},
            credentialError: "",
            async submitForm() {
                const form = this.$refs.form
                const data = new FormData(form)

                if (Object.keys(this.errors).length) return
                this.credentialError = ""

                try {
                    const response = await fetch("", {
                        method: "POST",
                        body: data
                    })

                    if (!response.ok) {
                        if (response.status === 403) {
                            return this.credentialError = "トークンが切れました。再読み込みしてください。"
                        }
                    }
                    const res = await response.json()

                    this.errors = {}

                    if (res.success === true) {
                        window.location.href = 'menu/';
                    } else if (res.success === false && res.error === "Invalid credentials") {
                        this.credentialError =  "ユーザー名またはパスワードが正しくありません。"
                    }

                } catch (error) {
                    this.credentialError =  "サーバーエラー。"
                }
            }
        }))
    })
</script>
{% endblock script %}
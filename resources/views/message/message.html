{% extends 'dashboard/master.html' %}
{% load static %}

{% block content %}

<div class = "mb-4 bg-gray-200 px-1 py-5">
    <h2 class = "text-2x1"> Message </h2>
    <h2 class = "text-2x1"> メッセージ </h2>
</div>

<div class = "px-5 py-5"> 
    <div class = "mb-4">
        <button id = "newMessage" class ="text-white bg-blue-500 hover:bg-blue-700 focus:ring-4 focus:ring font-medium rounded-lg px-5 py-3 text-center"> 
            + Create Message
        </button>
    </div>

    <!-- Message Box -->
    <div id = "newMessageBox" x-data="newMessageBox" class = "fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden z-50">
        <form class="bg-white p-5 rounded-lg w-full sm:max-w-lg mx-auto" x-clover-form="submitForm" action="{% url 'message' %}" method="post">
            {% csrf_token %}
            <div class ="bg-blue-500 px-4 py-3">
                <h3 class ="text-xl mb-4 text-white pt-3"> Create Message </h3>
            </div>
            <div class ="flex flex-wrap -mx-2">
                <div class = "w-full px-4 py-3">
                    <div class = "space-y-4">
                        <div>
                            <label for = "event" class = "block text-sm font-medium text-gray-700"> Event </label>
                            <select id="event"
                            class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500">
                            {% for event in events %}
                            <option value="{{ event.id }}">{{ event.name }}</option>
                            {% endfor %}
                            </select>                        
                        </div>
                        <div>
                            <label for = "subject" class = "block text-sm font-medium text-gray-700"> Subject </label>
                            <input type = "text" id = "subject" name ="subject" class ="mt-2 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 sm:text-sm" x-clover-verify>
                            <div x-text="errors.subject" class="text-red-500 text-sm mt-1"></div>
                        </div>
                        <div>
                            <label for="sender" class="block text-sm font-medium text-gray-700"> Sender </label>
                            <input type = "text" id="sender" name="sender" class="mt-2 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 sm:text-sm" x-clover-verify>
                            <div x-text="errors.sender" class="text-red-500 text-sm mt-1"></div>
                        </div>
                        <div>
                            <label for = "content" class = "block text-sm font-medium text-gray-700"> Content </label>
                            <textarea type = "text" id = "content" name = "content" rows = "3" class ="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 sm:text-sm resize-none"></textarea>
                        </div>
                        <div>
                            <label for = "period" class ="block text-sm font-medium text-gray-700"> Period </label>
                            <div class="flex flex-col space-y-2">

                                <div class="flex space-x-4">
                                    <div class="flex-1">
                                        <input type="datetime-local" id="startDate" name="startDate" x-model="startDate" class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 sm:text-sm" x-clover-verify>
                                        <span x-show="errors.startDate" x-text="errors.startDate" class="text-red-500 text-sm mt-1"></span>
                                    </div>
                                    <span class="text-gray-700 mt-2">to</span>
                                    <div class="flex-1">
                                        <input type="datetime-local" id="endDate" name="endDate" x-model="endDate" class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 sm:text-sm" x-clover-verify>
                                        <span x-show="errors.endDate" x-text="errors.endDate" class="text-red-500 text-sm mt-1"></span>
                                    </div>
                                </div>
                            </div>
                        </div>                       
                        <div>
                            <label for = "type" class = "block text-sm font-medium text-gray-700"> Type </label>
                            <select id="type"
                            class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500">
                            {% comment %} {% for type in types %}
                            <option value="{{ type.id }}">{{ type.name }}</option>
                            {% endfor %} {% endcomment %}
                            </select>                        
                        </div>
                    </div>
                </div>

                <div class="mt-8 flex justify-end w-full">
                    <button id="createMessage" type="submit"
                        class="text-white bg-blue-500 hover:bg-blue-700 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 mr-2">Register</button>
                    <button id="cancelCreation" type="button"
                        class="text-gray-700 bg-gray-200 hover:bg-gray-300 focus:ring-4 focus:ring-gray-300 font-medium rounded-lg text-sm px-5 py-2.5">Cancel</button>
                </div>
            </div>
        </form>
    </div>

    <!-- Detail Box -->
    <div id = "DetailBox" x-data = "DetailBox" class = "fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden z-50">
        <form class="bg-white p-5 rounded-lg w-full sm:max-w-lg mx-auto" x-clover-form="submit" method="post">
            <input type="hidden"  name="messageId"/>
            {% csrf_token %}
            <div class ="bg-blue-500 px-4 py-3">
                <h3 class ="text-xl mb-4 text-white pt-3"> Detail </h3>
            </div>
            <div class ="flex flex-wrap -mx-2">
                <div class = "w-full px-4 py-3">
                    <div class = "space-y-4">
                        <div>
                            <label for = "detailsubject" class = "block text-sm font-medium text-gray-700"> Subject </label>
                            <input type = "text" id = "detailsubject" name ="detailsubject" class ="mt-2 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for = "detailcontent" class = "block text-sm font-medium text-gray-700"> Content </label>
                            <textarea type = "text" id = "detailcontent" name = "detailcontent" rows = "3" class ="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 sm:text-sm resize-none"></textarea>
                        </div>
                        <div>
                            <label for = "detailperiod" class ="block text-sm font-medium text-gray-700"> Period </label>
                            <div class="flex space-x-4">
                                <input type="datetime-local" id="detailstartDate" name="detailstartDate" class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 sm:text-sm">
                                <span class="text-gray-700 mt-2">to</span>
                                <input type="datetime-local" id="detailendDate" name="detailendDate" class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 sm:text-sm">
                            </div>  
                        </div>                       
                        <div>
                            <label for = "detailtype" class = "block text-sm font-medium text-gray-700"> Type </label>
                            <select id="detailtype"
                            class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500">
                            {% comment %} {% for type in types %}
                            <option value="{{ type.id }}">{{ type.name }}</option>
                            {% endfor %} {% endcomment %}
                            </select>                        
                        </div>
                        <div>
                            <label for = "detailcreatedDate" class ="block text-sm font-medium text-gray-700"> Created Date </label>
                            <input type = "datetime-local" id = "detailcreatedDate" name = "detailcreatedDate" class = "mt-1 block w-full border-gray-300 bg-gray-500 rounded-md shadow-sm focus:ring-blue-500 sm:text-sm" readonly>
                        </div>
                        <div>
                            <label for = "detailfinishedDate" class ="block text-sm font-medium text-gray-700"> Finished Date </label>      
                            <input type = "datetime-local" id = "detailfinishedDate" name = "detailfinishedDate" class = "mt-1 block w-full border-gray-300 bg-gray-500 rounded-md shadow-sm focus:ring-blue-500 sm:text-sm" readonly>
                        </div>
                    </div>
                </div>

                <div class="mt-8 flex justify-end w-full">
                    <button id="editMessage" type="submit"
                        class="text-white bg-blue-500 hover:bg-blue-700 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 mr-2"> Edit </button>
                    <button id="cancelEdition" type="button"
                        class="text-gray-700 bg-gray-200 hover:bg-gray-300 focus:ring-4 focus:ring-gray-300 font-medium rounded-lg text-sm px-5 py-2.5"> Cancel </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- messagePages and Search Bar -->
<div class ="flex justify-between items-center mb-4 px-5">
    <div class ="flex items-center pb-4 mr-3">
        <select id="pagination"
        class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 p-2.5"
        style="width: 200px;">
        <option value="10" {% if per_page is "10" %}selected{% endif %}>10</option>
        <option value="20" {% if per_page is "20" %}selected{% endif %}>20</option>
        <option value="30" {% if per_page is "30" %}selected{% endif %}>30</option>
        <option value="40" {% if per_page is "40" %}selected{% endif %}>40</option>
        <option value="50" {% if per_page is "50" %}selected{% endif %}>50</option>
    </select>
    <label for="messagePages" class = "ml-2 font-medium text-gray-700"> Shown Pages </label>
    </div>
    <div class="relative flex items-center">
        <input type="text" id="search"
            class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 pl-10"
            placeholder="Search by name or ID">
        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <svg aria-hidden="true" class="w-5 h-5 text-gray-500" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd"
                    d="M12.9 14.32a8 8 0 111.41-1.41l5.38 5.38a1 1 0 01-1.42 1.42l-5.37-5.39zM8 14A6 6 0 108 2a6 6 0 000 12z"
                    clip-rule="evenodd" />
            </svg>
        </div>
        <button
            class="ml-2 text-white bg-blue-500 hover:bg-blue-700 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5">Search</button>
    </div>
</div>

<!-- Messages Table -->
<div class = "overflow-x-auto relative shadow-md sm:rounded-lg px-5">
    <table class = "w-full text-sm text-left text-gray-500">
        <thead class = "text-xs text-gray-700 uppercase bg-gray-50">
            <tr>
                <th scope ="col" class = "px-6 py-3 w-4"></th>
                <th scope ="col" class = "px-6 py-3 w-4"> Message ID </th>
                <th scope ="col" class = "px-6 py-3 w-4"> Sender </th>
                <th scope ="col" class = "px-6 py-3 w-4"> Subject </th>
                <th scope ="col" class = "px-6 py-3 w-4"> Period </th>
                <th scope ="col" class = "px-6 py-3 w-4"> Situation </th>
            </tr>
        </thead>
        <tbody>

            {% for message in messages %}
            <tr class="bg-white border-b">
                <td class="py-4 px-6">
                    <button
                        class="text-white bg-blue-500 hover:bg-blue-700 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-4 py-2 open-edit-modal"
                        data-message-id="{{ message.id }}"> Details </button>
                </td>
                <td class="py-4 px-6">{{ message.id }}</td>
                <td class="py-4 px-6">{{ message.sender }}</td>
                <td class="py-4 px-6">{{ message.subject }}</td>
                <td class="py-4 px-6">{{ message.startDate }} to {{ message.endDate }} </td>
                <td class="py-4 px-6">{{ message.status }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="flex justify-between items-center mt-4 px-5">
    <div class="text-sm text-gray-700">
        Showing <span class="font-medium">{{ page.start_index }}</span> to
        <span class="font-medium">{{ page.end_index}}</span> of
        <span class="font-medium">{{ page.paginator.count }}</span> results
    </div>
    <nav aria-label="Page navigation">
        <ul class="inline-flex items-center -space-x-px">
            {% if page.has_previous %}
            <li>
                <a href="?page={{ page.previous_page_number }}&per_page={{ per_page }}"
                    class="block py-2 px-3 leading-tight text-gray-500 bg-white border border-gray-300 rounded-l-lg hover:bg-gray-100 hover:text-gray-700">
                    <span class="sr-only">Previous</span>
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd"
                            d="M12.293 4.293a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L13 7.414V17a1 1 0 11-2 0V7.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4z"
                            clip-rule="evenodd" />
                    </svg>
                </a>
            </li>
            {% endif %}
            {% for num in page.paginator.page_range %}
            <li>
                <a href="?page={{ num }}&per_page={{ per_page }}"
                    class="block py-2 px-3 leading-tight text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700">
                    {{ num }}</a>
            </li>
            {% endfor %}
            {% if page.has_next %}
            <li>
                <a href="?page={{ page.next_page_number }}&per_page={{ per_page }}"
                    class="block py-2 px-3 leading-tight text-gray-500 bg-white border border-gray-300 rounded-r-lg hover:bg-gray-100 hover:text-gray-700">
                    <span class="sr-only">Next</span>
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd"
                            d="M7.707 15.707a1 1 0 01-1.414-1.414L11.586 9 6.293 3.707a1 1 0 011.414-1.414l5 5a1 1 0 010 1.414l-5 5z"
                            clip-rule="evenodd" />
                    </svg>
                </a>
            </li>
            {% endif %}
        </ul>
    </nav>
    <div class="mt-4 flex justify-end py-3 px-3">
        showing to results
        <span class="ml-2 inline-flex">
            <button class="px-3 py-1 border border-gray-300 rounded-l-md bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">Previous</button>
            <button class="px-3 py-1 border-t border-b border-gray-300 bg-blue-500 hover:bg-blue-700 text-sm font-medium text-white">1</button>
            <button class="px-3 py-1 border border-gray-300 rounded-r-md bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">Next</button>
        </span>
    </div>
</div>

{% endblock content %}

{% block script %}
<script>
    const newMessageButton = document.getElementById("newMessage");
    const closeMessageButton = document.getElementById("cancelCreation");
    const messageBox = document.getElementById("newMessageBox");
    const detailBox = document.getElementById("DetailBox");

    newMessageButton.addEventListener('click', () => {
        messageBox.classList.remove('hidden');
    })

    closeMessageButton.addEventListener('click', () => {
        messageBox.classList.add('hidden'); 
    })

    document.addEventListener('DOMContentLoaded', function () {
        const paginationSelect = document.getElementById('pagination');
        paginationSelect.value = "{{ per_page }}"; 

        paginationSelect.addEventListener('change', function () {
            const perPage = paginationSelect.value;
            const urlParams = new URLSearchParams(window.location.search);
            urlParams.set('per_page', perPage);
            window.location.search = urlParams.toString();
        });
    });

    // Show data from database
    document.addEventListener('DOMContentLoaded', function () {
        const openEditButton = document.querySelectorAll('.open-edit-modal');

        openEditButton.forEach(button => {
            button.addEventListener('click', function () {
                const messageId = button.getAttribute('data-message-id');
                if (!messageId) {
                    console.error('Message ID attribute is missing or invalid.');
                    return;
                }
                console.log("Message ID: ", messageId);

                const url = `/message/get_message_data/${messageId}/`;

                fetch(url)
                    .then(async response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok.');
                        }
                        return response.json();
                    })
                    .then(detail => {
                        console.log('Fetched data:', detail);

                        document.querySelector("[name='messageId']").value = messageId
                        document.getElementById('detailsubject').value = detail.subject || '';
                        document.getElementById('detailcontent').value = detail.content || '';
                        document.getElementById('detailstartDate').value = detail.startDate ? new Date(detail.startDate).toISOString().slice(0, 16) : '';
                        document.getElementById('detailendDate').value = detail.endDate ? new Date(detail.endDate).toISOString().slice(0, 16) : '';
                        document.getElementById('detailtype').value = detail.type || '';
                        //document.getElementById('detailcreatedDate').value = detail.createdDate || '';
                        //document.getElementById('detailfinishedDate').value = detail.finishedDate || '';
                    
                        detailBox.classList.remove('hidden');
                    })
                    .catch(error => console.error('Error fetching message data:', error));
                   
            });
        });

        const cancelEditionButton = document.getElementById('cancelEdition');
        if (cancelEditionButton) {
            cancelEditionButton.addEventListener('click', function () {
                detailBox.classList.add('hidden');
            });
        }
    });

    // Create and Edit 
    document.addEventListener('alpine:init', () => {
        // Create
        Alpine.data('newMessageBox', () => ({
            rule: {
                "subject" : [Clover.rule.required("Please input subject.")],
                "sender" : [Clover.rule.required("Please input sender.")],
                "content" : [Clover.rule.required()],
                "startDate" : [Clover.rule.required("Please choose startDate")],
                "endDate" : [Clover.rule.required("Please choose endDate")],
                //"type" : [Clover.rule.required()],
            },
            errors: {},
            async submitForm(){
                const form = this.$el
                const data = new FormData(form)

                //console.log(data)

                try {
                    const response = await fetch("", {
                        method: "POST",
                        body: data
                    })
                
                const res = await response.text()    

                if (!response.ok){
                    throw new Error(res.error || 'Failed to create.');
                }

                console.log(res)

                if (messageBox) {
                    messageBox.classList.add('hidden');
                }        
                
                }catch(error) {
                    console.log(error);
                }
            }
        }));

        // Edit
        Alpine.data('DetailBox', () => ({
            rule: {
                "detailsubject" : [Clover.rule.required()],
                "detailcontent" : [Clover.rule.required()],
                "detailstartDate" : [Clover.rule.required()],
                "detailendDate" : [Clover.rule.required()],
                //"detailtype" : [Clover.rule.required()],
            },
            errors: {},
            async submit(){
                const form = this.$el
                const data = new FormData(form)
                const messageId = form.elements["messageId"].value;
                if (!messageId) {
                    console.error('Message ID attribute is missing or invalid.');
                    return;
                }

                try {
                    const response = await fetch(`/message/get_message_data/${messageId}/`, {
                        method: "POST",
                        body: data
                    })
                
                const res = await response.json()    

                if (!response.ok){
                    throw new Error(res.error || 'Failed to edit.');
                }

                console.log(res)

                if (detailBox) {
                    console.log(detailBox)
                    detailBox.classList.add('hidden');
                }        
                
                }catch(error) {
                    console.log(error);
                }
            }
        }));
    })
    

</script>
{% endblock script %}